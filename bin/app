#!/usr/bin/env bash

usage() {
    echo "Usage of app command:

    deploy-dart                     Deploy SDK to Dart Packages registry (pub.dartlang.org).
    deploy-js                       Deploy SDK to npmjs.com registry.
    generate                        Generate documentations, sources and tests thanks to swagger definition.
    "
}

check() {
    command -v ${1} 1>/dev/null 2>&1 || {
        if [ -z "${2}" ]; then
            echo -e 1>&2 "You need ${1} to execute this command....  Aborting.";
        else
            echo -e 1>&2 "You need ${1} to execute this command....  Aborting.\nTo install ${1}: ${2}";
        fi

        exit 1;
    }
}

deploy-dart() {
    CURRENT_DIR=$(pwd)

    echo "
    ----------------------------------------------------------------------
    Deploying keyclic_sdk_api to Dart Packages registry (pub.dartlang.org)
    ----------------------------------------------------------------------
    "

    WORKING_DIR=dart

    cd ${CURRENT_DIR}/dart || { echo -e "Cannot find ${WORKING_DIR} directory"; exit 1; }

    echo -e " Change some files to match requirements of pubspec.yaml specifications."
    if [[ -d "docs" ]]; then mv docs doc; fi
    cp ../LICENSE .

    pub publish

    cd ${CURRENT_DIR} || exit
}

deploy-js() {
    CURRENT_DIR=$(pwd)

    echo "
    ---------------------------------------
    Deploying @keyclic/app-sdk to npmjs.com
    ---------------------------------------

    Need to be logged to npmjs registry,
    add user with \"npm adduser --scope=@keyclic\" command.
    "

    WORKING_DIR=javascript-es6

    cd ${CURRENT_DIR}/${WORKING_DIR} || { echo -e "Cannot find ${WORKING_DIR} directory"; exit 1; }

    echo -e "Prepare javascript-es6 package."
    rm -rf dist 2>&1
    mkdir -p dist
    cp -R bundle dist/.
    cp -R src dist/.
    cp package.json dist/.
    cp ../LICENSE dist/.

    echo -e "Publish javascript-es6 package."
    npm publish dist --access public

    rm -rf dist 2>&1

    cd ${CURRENT_DIR} || exit
}

pana() {
    check pana "pub global activate pana"

    # scores package
    pana --source path dart --scores --verbosity compact
}

generate() {
  check pub
  check dartfmt

  ./bin/generate "$@"
}

main() {
    if [[ -z ${1} ]]; then
        usage
        exit 0
    fi

    if [[ ! ${1} =~ ^deploy-dart|deploy-js|generate$ ]]; then
        echo "${1} is not a supported command."
        exit 1
    fi

    "$@"
}

main "$@"
