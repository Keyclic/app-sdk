#!/usr/bin/env bash

usage() {
    echo "Usage of command:

    deploy                          Deploy project to npmjs.com registry.
    generate                        Generate documentations, sources and tests thanks to swagger definition.
    "
}

deploy () {
    CURRENT_DIR=$(pwd)

    echo "---------------------------------------"
    echo "Deploying @keyclic/app-sdk to npmjs.com"
    echo "---------------------------------------"

    echo
    echo "Need to be logged to npmjs registry,"
    echo "add user with \"npm adduser --scope=@keyclic\" command."

    cd ${CURRENT_DIR}/javascript-es6 || exit
    # Prepare javascript-es6 package.
    rm -rf dist
    mkdir -p dist
    cp -R bundles dist/.
    cp -R src dist/.
    cp package.json dist/.
    npm publish dist --access public

    cd ${CURRENT_DIR}/dart || exit
    # Change some files to match requirements of pubspec.yaml specifications.
    if [[ -d "docs" ]]; then mv docs doc; fi
    cp ../LICENSE .
    grep -q "author:" pubspec.yaml || echo "author: Keyclic techies team <techies@keyclic.com>" >> pubspec.yaml
    grep -q "environment:" pubspec.yaml || echo "environment:" >> pubspec.yaml
    grep -q "sdk:" pubspec.yaml || echo "  sdk: \"<3.0.0\"" >> pubspec.yaml
    grep -q "homepage:" pubspec.yaml || echo "homepage: https://keyclic.com" >> pubspec.yaml
    /usr/lib/dart/bin/pub publish

    cd ${CURRENT_DIR} || exit
}

generate () {
    ./bin/generate
}

main () {
    if [ -z $1 ]; then
        usage
        exit 0
    fi

    if [[ ! $1 =~ ^deploy|generate$ ]]; then
        echo "$1 is not a supported command."
        exit 1
    fi

    "$@"
}

main "$@"
